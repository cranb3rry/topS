<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="/static/home/styles.css">
    <link rel="shortcut icon" href="/static/polls/favicon.ico.png"/>
    <title>Chat Room</title>
</head>
<style type="text/css">
    p {
  margin: 4px;
}
</style>
<body>
    <div id="chat-log" cols="60" rows="20" readonly>
    {% for message in message_log %}
        <p>{{message}}</p>
    {% endfor %}
</div><br/>
    <input id="chat-message-input" type="text" size="60"/><br/>
    <input id="chat-message-submit" type="button" value="Send"/>
      <input id="user-message-skip" type="button" value="Skip"/>
</body>
<script>
    var roomName = {{ room_name_json }};

    var chatSocket = new WebSocket(
        'wss://' + window.location.host +
        '/ws/chat/' + roomName + '/');

    chatSocket.onmessage = function(e) {
    var element = document.getElementById("chat-log");
    // element.innerHTML = "";
    var node = document.createElement("p");
    var textnode = document.createTextNode(JSON.parse(e.data)['message']+' '+'\n');    
    node.appendChild(textnode);   
    element.appendChild(node);   
    node.scrollIntoView();
    };


    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        var messageInputDom = document.querySelector('#chat-message-input');
        var message = messageInputDom.value;

        chatSocket.send(JSON.stringify({
            'message': message,
            'user': 'user'
        }));

        
        messageInputDom.value = '';
    };

    var wsvc = new WebSocket(
        'wss://' + window.location.host +
        '/ws/vcmsg/')


wsvc.onmessage = function (event) {

    console.log(event.data)
    var msg = JSON.parse(event.data);
    var element = document.getElementById("chat-log");
    var node = document.createElement("p");
    node.className+='vcmsg' 
    switch(msg.type) {
        case "voice_message":
            var textnode = document.createTextNode(msg.name+': '+msg.message[0]+' ');
            break
        case "skip":
            var textnode = document.createTextNode('skip');          
            break
        case "greet":
            var textnode = document.createTextNode(msg['message']);
            break
        }
        node.appendChild(textnode);
        element.appendChild(node);
        node.scrollIntoView();
};


document.querySelector('#user-message-skip').onclick = function(e) {
    wsvc.send(JSON.stringify({
        'ctrl': 'skip',
    }));


};
</script>
</html>